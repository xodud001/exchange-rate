<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="#{label.title}">환율 계산</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reset-css@5.0.1/reset.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.12.4.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/exchangeForm.css}">
</head>
<body>
<div id="body__container">
    <header>
        <h1 class="title" th:text="#{label.title}">환율 계산</h1>
    </header>
    <form action="/exchange" method="post">
        <div>
            <span th:text="#{label.exchange.from}">송금국가</span>:
            <span th:text="${rates[0].from}"> 미국(USD)</span>
        </div>
        <label>
            <span th:text="#{label.exchange.to}">수취국가</span>:
            <select id="rateCode" name="rateCode" class="form-select"  onchange="changeRateSelect()" style="display: inline-block">
                <option value="">==수취국가 선택==</option>
                <option th:each="rate : ${rates}" th:value="${rate.toCode}"
                        th:text="${rate.to}"></option>
            </select>
        </label>
        <div>
            <span th:text="#{label.exchange.rate}">환율</span>:
            <span id="display">수취국가를 선택해주세요</span>
        </div>
        <div>
            <span th:text="#{label.exchange.amount}">송금액</span>:
            <input id="amount" name="amount" type="text" placeholder="$0 ~ $10,000"/>
            <span th:text="${rates[0].fromCode}">USD</span>:
        </div>
        <a class="btn btn-primary" th:text="#{button.submit}" onClick="calExchange();"></a>
        <div id="result"></div>
    </form>
</div>
<script defer th:inline="javascript">
    function changeRateSelect(){
        const rates = [[${rates}]];
        const rateSelect = document.getElementById("rateCode");
        const display = document.getElementById("display");

        if (rateSelect.selectedIndex > 0) {
            display.innerText = rates[rateSelect.selectedIndex-1].rateMessage;
        }else{
            display.innerText = '수취국가를 선택해주세요';
        }
    }

    function calExchange(){
        const rates = [[${rates}]];
        const rateSelect = document.getElementById("rateCode");
        const amount = document.getElementById("amount");
        const result = document.getElementById("result");

        if(rateSelect.selectedIndex === 0){
            alert("수취국가를 선택해주세요");
            return;
        }

        if(Number(amount.value) < 0){
            alert("$0 보다 작은 금액은 입력하실 수 없습니다")
            return;
        }
        
        if(Number(amount.value) > 10000){
            alert("$10,000 보다 큰 금액은 입력하실 수 없습니다")
            return;
        }

        const calAmount = (amount.value * rates[rateSelect.selectedIndex - 1].rate).toLocaleString(undefined, {maximumFractionDigits: 2});

        result.innerText = `수취금액은 ${calAmount} ${rates[rateSelect.selectedIndex - 1].toCode}입니다`
    }

    function checkInput(){
        const replaceNotInt = /[^0-9]/gi;

        $(document).ready(function(){
            $("#amount").on("focusout", function() {
                let x = $(this).val();
                if (x.length > 0) {
                    if (x.match(replaceNotInt)) {
                        x = x.replace(replaceNotInt, "");
                    }
                    $(this).val(x);
                }
            }).on("keyup", function() {
                $(this).val($(this).val().replace(replaceNotInt, ""));
            });

        });
    }

    checkInput();
    changeRateSelect();
</script>
</body>
</html>